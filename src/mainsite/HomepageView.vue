<script setup lang="js">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import BottomNav from '@/common/layout/BottomNav.vue'
import { supabase } from '@/utils/supabase'
import { messaging } from '@/utils/firebase'
import { getToken } from 'firebase/messaging'
import { Geolocation } from '@capacitor/geolocation'
import { PushNotifications } from '@capacitor/push-notifications'
import { Network } from '@capacitor/network'
import { Capacitor } from '@capacitor/core'

const router = useRouter()
const activeTab = ref('home')
const search = ref('')
const products = ref([])
const nearby = ref([])
const loading = ref(true)
const errorMsg = ref('')

const PLACEHOLDER_IMG = 'https://picsum.photos/seed/shop/480/360'

/* 🧭 Location Permission */
async function requestLocationPermission() {
  try {
    const perm = await Geolocation.requestPermissions()
    if (perm.location === 'granted') {
      const coords = await Geolocation.getCurrentPosition()
      console.log('📍 User location:', coords.coords)
      return coords.coords
    } else {
      alert('Please enable location permission to see nearby shops.')
      return null
    }
  } catch (err) {
    console.error('Error requesting location:', err)
    return null
  }
}

/* 🔔 Notifications Permission */
async function requestPushPermission() {
  try {
    const permStatus = await PushNotifications.checkPermissions()
    if (permStatus.receive !== 'granted') {
      const req = await PushNotifications.requestPermissions()
      if (req.receive !== 'granted') {
        console.warn('Notifications permission denied.')
        return
      }
    }

    await PushNotifications.register()

    PushNotifications.addListener('registration', (token) => {
      console.log('✅ Push token:', token.value)
    })

    PushNotifications.addListener('registrationError', (error) => {
      console.error('❌ Push registration error:', error)
    })
  } catch (err) {
    console.error('Error requesting push permission:', err)
  }
}

/* 🌐 Network Status */
async function checkNetworkStatus() {
  try {
    const status = await Network.getStatus()
    console.log('📶 Network status:', status)
    if (!status.connected) {
      alert('No internet connection. Please connect to Wi-Fi or mobile data.')
    }

    Network.addListener('networkStatusChange', (status) => {
      console.log('🌐 Network changed:', status)
      if (!status.connected) {
        alert('⚠️ You are offline.')
      } else {
        console.log('✅ Back online.')
      }
    })
  } catch (err) {
    console.error('Network check error:', err)
  }
}

/* 📡 Firebase Token */
async function requestForToken() {
  try {
    const permission = await Notification.requestPermission()
    if (permission !== 'granted') {
      console.warn('Notification permission denied.')
      return null
    }

    const vapidKey = 'BOiw6_vllLo5TOjouOP8mMK_zhynZ8wakUg8ZgP_gfH9YwpUJ2ils7HCq15LBWpFq1pZvXGzye01pjUIDOjY6P8'
    const token = await getToken(messaging, { vapidKey })

    if (token) {
      console.log('✅ FCM Token:', token)
      return token
    } else {
      console.warn('No registration token available.')
      return null
    }
  } catch (err) {
    console.error('Error getting FCM token:', err)
    return null
  }
}

/* 🏪 Fetch Shops */
async function fetchShops() {
  try {
    const { data, error } = await supabase
      .from('shops')
      .select('id, business_name, description, logo_url, physical_store, building, street, barangay, city, province, region')
      .order('business_name')

    if (error) throw error

    nearby.value = (data || []).map((s) => ({
      id: s.id,
      title: s.business_name,
      img: s.physical_store || PLACEHOLDER_IMG,
      logo: s.logo_url,
      address: [s.building, s.street, s.barangay, s.city, s.province, s.region]
        .filter(Boolean)
        .join(', '),
    }))
  } catch (err) {
    console.error('fetchShops error:', err)
    errorMsg.value = err.message
    nearby.value = []
  }
}

/* 🛍️ Fetch Products */
async function fetchProducts() {
  try {
    const { data, error } = await supabase
      .from('products')
      .select('id, prod_name, price, main_img_urls, shop_id, sold')

    if (error) throw error

    products.value = (data || []).map((p) => ({
      id: p.id,
      title: p.prod_name || 'Untitled product',
      price: p.price,
      img: extractImage(p.main_img_urls),
      sold: p.sold || 0,
    }))
  } catch (err) {
    console.error('fetchProducts error:', err)
    errorMsg.value = err.message
    products.value = []
  }
}

/* 🖼️ Normalize Image */
function extractImage(main_img_urls) {
  if (!main_img_urls) return PLACEHOLDER_IMG
  if (Array.isArray(main_img_urls) && main_img_urls.length) return main_img_urls[0]
  if (typeof main_img_urls === 'string') {
    try {
      const parsed = JSON.parse(main_img_urls)
      if (Array.isArray(parsed) && parsed.length) return parsed[0]
    } catch {
      return main_img_urls
    }
  }
  return PLACEHOLDER_IMG
}

/* 🚀 Main Lifecycle */
onMounted(async () => {
  try {
    loading.value = true
    errorMsg.value = ''

    // Request permissions (only on native builds)
    if (Capacitor.isNativePlatform()) {
      await checkNetworkStatus()
      await requestLocationPermission()
      await requestPushPermission()
    }

    // Load data
    await Promise.all([fetchShops(), fetchProducts()])
    loading.value = false

    // Save FCM token
    const { data: { user } } = await supabase.auth.getUser()
    if (user) {
      const token = await requestForToken()
      if (token) {
        const { error } = await supabase
          .from('user_fcm_tokens')
          .upsert({ user_id: user.id, token }, { onConflict: 'user_id' })
        if (error) console.error('Error saving FCM token:', error)
        else console.log('✅ Token saved to Supabase')
      }
    }
  } catch (err) {
    console.error('❌ Error in onMounted:', err)
  } finally {
    loading.value = false
  }
})

/* 🧭 Navigation */
const onSearch = () => {
  if (!search.value.trim()) return
  router.push({ name: 'search', query: { q: search.value.trim() } })
}
const seeMoreNearby = () => router.push('/mapsearch')
const goNotifications = () => router.push('/notificationview')
const goToProduct = (id) => router.push({ name: 'product-detail', params: { id } })
const goToShop = (id) => router.push({ name: 'shop-view', params: { id } })
</script>

<template>
  <v-app>
    <v-main class="page">
      <v-container class="py-4" style="max-width: 720px">
        <!-- 🔎 Search + Notification -->
        <v-sheet class="hero pa-4">
          <div class="hero-row">
            <v-text-field
              v-model="search"
              class="search-field"
              variant="solo"
              rounded="pill"
              hide-details
              clearable
              density="comfortable"
              placeholder="Looking for something specific?"
              prepend-inner-icon="mdi-magnify"
              append-inner-icon="mdi-earth"
              @keyup.enter="onSearch"
              @click:prepend-inner="onSearch"
            />
            <v-btn class="notif-btn" icon aria-label="Notifications" @click="goNotifications">
              <v-icon size="22">mdi-bell-outline</v-icon>
            </v-btn>
          </div>
        </v-sheet>

        <!-- 🏬 Nearby Stores -->
        <div class="section-header mt-6">
          <h3 class="section-title">Nearby Stores</h3>
          <button class="see-more" @click="seeMoreNearby">See more</button>
        </div>

        <div class="scroll-row">
          <template v-if="loading">
            <v-skeleton-loader v-for="i in 4" :key="'near-skel-' + i" type="image" class="item-card" />
          </template>
          <template v-else-if="nearby.length === 0">
            <div class="empty-card">
              <div class="empty-title">Nothing nearby yet</div>
              <div class="empty-sub">Location-based results coming soon.</div>
            </div>
          </template>
          <template v-else>
            <div v-for="item in nearby" :key="item.id" class="item-card" @click="goToShop(item.id)">
              <v-img :src="item.img" cover class="item-img" />
              <div class="item-footer">
                <v-avatar class="avatar-badge" size="20">
                  <v-img :src="item.logo || PLACEHOLDER_IMG" />
                </v-avatar>
                <div class="item-title">{{ item.title }}</div>
              </div>
            </div>
          </template>
        </div>

        <!-- 🛒 Products -->
        <div class="section-header mt-6">
          <h3 class="section-title">Browse Products</h3>
        </div>

        <template v-if="loading">
          <div class="product-grid">
            <v-skeleton-loader v-for="i in 6" :key="'prod-skel-' + i" type="image" class="product-card" />
          </div>
        </template>
        <template v-else-if="products.length === 0">
          <div class="empty-card">
            <div class="empty-title">No products yet</div>
            <div class="empty-sub">Products will appear here.</div>
          </div>
        </template>
        <template v-else>
          <div class="product-grid">
            <div v-for="item in products" :key="item.id" class="product-card" @click="goToProduct(item.id)">
              <v-img :src="item.img" class="product-img" cover />
              <div class="product-info">
                <div class="product-title">{{ item.title }}</div>
                <div class="product-price">₱{{ Number(item.price).toFixed(2) }}</div>
                <div class="product-sold">{{ item.sold }} sold</div>
              </div>
            </div>
          </div>
        </template>

        <v-alert v-if="errorMsg" class="mt-6" type="error" variant="tonal">
          {{ errorMsg }}
        </v-alert>
      </v-container>
    </v-main>
    <BottomNav v-model="activeTab" />
  </v-app>
</template>
<style scoped>
.page {
  background: #f5f7fa;
  padding-bottom: 96px;
}

.hero {
  background: #e5f1f8;
  border-radius: 14px;
}

.hero-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.search-field {
  flex: 1;
}

.search-field :deep(.v-field) {
  background: #fff !important;
  box-shadow: 0 6px 20px rgba(0, 0, 0, .06);
}

.search-field :deep(input) {
  font-size: 14px;
}

.notif-btn {
  width: 44px;
  height: 44px;
  min-width: 44px;
  border-radius: 9999px;
  background: #fff !important;
  box-shadow: 0 6px 20px rgba(0, 0, 0, .06);
}

.notif-btn :deep(.v-icon) {
  color: #111827;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.section-title {
  font-size: 16px;
  font-weight: 700;
  color: #1f2937;
}

.see-more {
  background: transparent;
  border: 0;
  color: #6b7280;
  font-weight: 600;
  cursor: pointer;
}

.scroll-row {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding: 10px 2px 2px;
  scroll-snap-type: x mandatory;
}

.scroll-row::-webkit-scrollbar {
  display: none;
}

.item-card {
  position: relative;
  flex: 0 0 calc(33.333% - 12px);
  height: 140px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
  background: #fff;
  scroll-snap-align: start;
  display: flex;
  flex-direction: column;
  justify-content: flex-end; /* push footer to bottom */
}

.item-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 0;
}

.item-footer {
  position: relative;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  background: #4490dd;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  z-index: 1;
}

.avatar-badge {
  border: 2px solid #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, .15);
  flex-shrink: 0;
}

.item-title {
  font-size: 12px;
  font-weight: 700;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

.item-meta {
  position: absolute;
  left: 36px;
  right: 8px;
  bottom: 6px;
  color: #fff;
}

.item-sub {
  font-size: 10px;
  opacity: .9;
  text-shadow: 0 1px 2px rgba(0, 0, 0, .35);
}

.empty-card {
  width: 240px;
  height: 124px;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 12px;
}

.empty-title {
  font-weight: 700;
  color: #1f2937;
}

.empty-sub {
  font-size: 12px;
  color: #6b7280;
}

.mt-6 {
  margin-top: 24px;
}

.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.product-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
  display: flex;
  flex-direction: column;
  transition: transform 0.15s ease;
  cursor: pointer;
}

.product-card:hover {
  transform: translateY(-2px);
}

.product-img {
  width: 100%;
  height: 160px;
  object-fit: cover;
}

.product-info {
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.product-title {
  font-size: 13px;
  font-weight: 500;
  color: #111827;
  line-height: 1.3;
  height: 32px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.product-price {
  font-size: 14px;
  font-weight: 700;
  color: #e53935;
}

.product-sold {
  font-size: 12px;
  color: #6b7280;
}

/* ✅ Keep products 2-column layout for small devices (e.g. 350x800) */
@media (max-width: 480px) {
  .product-grid {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 10px;
  }

  .product-card {
    height: auto;
  }

  .product-img {
    height: 140px;
  }

  .product-title {
    font-size: 12px;
  }

  .product-price {
    font-size: 13px;
  }

  .product-sold {
    font-size: 11px;
  }
}
</style>
